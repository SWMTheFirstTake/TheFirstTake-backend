# name: Spring Boot CI/CD

# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     branches:
#       - main

# jobs:
#   build-and-test:
#     runs-on: ubuntu-latest

#     env:
#       POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
#       POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
#       POSTGRES_ENDPOINT: ${{ secrets.POSTGRES_ENDPOINT }}
#       LLM_SERVER_HOST: ${{ secrets.LLM_SERVER_HOST }}
#       LLM_SERVER_PORT: ${{ secrets.LLM_SERVER_PORT }}
#       AI_SERVER_HOST: ${{ secrets.AI_SERVER_HOST }}
#       AI_SERVER_PORT: ${{ secrets.AI_SERVER_PORT }}
#       REDIS_ENDPOINT: ${{ secrets.REDIS_ENDPOINT }}
#       AWS_ACCESS_KEY: ${{secrets.AWS_ACCESS_KEY}}
#       AWS_SECRET_KEY: ${{secrets.AWS_SECRET_KEY}}
#       FITROOM_API_KEY: ${{ secrets.FITROOM_API_KEY }}

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up JDK 21
#         uses: actions/setup-java@v3
#         with:
#           java-version: '21'
#           distribution: 'temurin'

#       - name: Grant execute permission for gradlew
#         run: chmod +x ./thefirsttake/gradlew

#       - name: Build
#         run: cd thefirsttake && ./gradlew clean build

#       - name: Upload build artifact for deployment
#         uses: actions/upload-artifact@v4
#         with:
#           name: app-jar
#           path: thefirsttake/build/libs/*.jar

#   deploy:
#     needs: build-and-test
#     runs-on: ubuntu-latest

#     env:
#       SERVER_IP: ${{ secrets.SERVER_IP }}
#       SERVER_USER: ${{ secrets.SERVER_USER }}
#       SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
#       LLM_SERVER_HOST: ${{ secrets.LLM_SERVER_HOST }}
#       LLM_SERVER_PORT: ${{ secrets.LLM_SERVER_PORT }}
#       AI_SERVER_HOST: ${{ secrets.AI_SERVER_HOST }}
#       AI_SERVER_PORT: ${{ secrets.AI_SERVER_PORT }}
#       POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
#       POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
#       POSTGRES_ENDPOINT: ${{ secrets.POSTGRES_ENDPOINT }}
#       REDIS_ENDPOINT: ${{ secrets.REDIS_ENDPOINT }}
#       AWS_ACCESS_KEY: ${{secrets.AWS_ACCESS_KEY}}
#       AWS_SECRET_KEY: ${{secrets.AWS_SECRET_KEY}}
#       FITROOM_API_KEY: ${{ secrets.FITROOM_API_KEY }}

#     steps:
#       - name: Download build artifact
#         uses: actions/download-artifact@v4
#         with:
#           name: app-jar
#           path: ./deploy

#       - name: Copy jar to server
#         uses: appleboy/scp-action@v0.1.4
#         with:
#           host: ${{ env.SERVER_IP }}
#           username: ${{ env.SERVER_USER }}
#           key: ${{ env.SERVER_SSH_KEY }}
#           source: "./deploy/*.jar"
#           target: "/home/${{ env.SERVER_USER }}/app/"

#       - name: Restart app on server
#         uses: appleboy/ssh-action@v0.1.5
#         with:
#           host: ${{ env.SERVER_IP }}
#           username: ${{ env.SERVER_USER }}
#           key: ${{ env.SERVER_SSH_KEY }}
#           script: |
#             # ì• í”Œë¦¬ì¼€ì´ì…˜ JAR íŒŒì¼ì˜ ì´ë¦„ì„ ì°¾ìŠµë‹ˆë‹¤.
#             # -plain.jar íŒŒì¼ì„ ì œì™¸í•˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ JAR íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤.
#             JAR_NAME=$(ls /home/${{ env.SERVER_USER }}/app/deploy/*.jar | grep -v "plain.jar" | head -n 1)
#             echo "Found JAR file: $JAR_NAME"
            
#             # JAR íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
#             if [ ! -f "$JAR_NAME" ]; then
#                 echo "Error: JAR file not found at $JAR_NAME"
#                 exit 1
#             fi
            
#             # JAR íŒŒì¼ëª…ë§Œ ì¶”ì¶œ (ê²½ë¡œ ì œê±°)
#             JAR_FILENAME=$(basename "$JAR_NAME")
#             echo "JAR filename: $JAR_FILENAME"
            
#             # ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  JAR íŒŒì¼ ëª©ë¡ì„ í™•ì¸í•©ë‹ˆë‹¤.
#             echo "=== All JAR files in deploy directory ==="
#             ls -la /home/${{ env.SERVER_USER }}/app/deploy/*.jar
            
#                         # ê¸°ì¡´ ì„œë¹„ìŠ¤ê°€ ìˆë‹¤ë©´ ì¤‘ì§€í•©ë‹ˆë‹¤.
#             # '|| true'ëŠ” ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆì–´ë„ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¤ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
#             sudo systemctl stop thefirsttake.service || true
            
#             # ê¸°ì¡´ ì„œë¹„ìŠ¤ íŒŒì¼ì„ ì™„ì „íˆ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.
#             sudo rm -f /etc/systemd/system/thefirsttake.service
            
#             # systemd ì„œë¹„ìŠ¤ íŒŒì¼ì„ ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.
#             echo '[Unit]' | sudo tee /etc/systemd/system/thefirsttake.service
#             echo 'Description=TheFirstTake Spring Boot Application' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'After=network.target' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo '' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo '[Service]' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Type=simple' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'User=${{ env.SERVER_USER }}' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'WorkingDirectory=/home/${{ env.SERVER_USER }}/app' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo "ExecStart=/usr/bin/java -jar /home/${{ env.SERVER_USER }}/app/deploy/$JAR_FILENAME" | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Restart=always' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'RestartSec=10' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo '' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo '# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Environment="SPRING_DATASOURCE_URL=jdbc:postgresql://${{ secrets.POSTGRES_ENDPOINT }}:5432/postgres?sslmode=require"' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Environment="SPRING_DATASOURCE_USERNAME=${{ secrets.POSTGRES_USER }}"' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Environment="SPRING_DATASOURCE_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}"' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Environment="SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver"' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Environment="LLM_SERVER_HOST=${{ secrets.LLM_SERVER_HOST }}"' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Environment="LLM_SERVER_PORT=${{ secrets.LLM_SERVER_PORT }}"' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Environment="AI_SERVER_HOST=${{ secrets.AI_SERVER_HOST }}"' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Environment="AI_SERVER_PORT=${{ secrets.AI_SERVER_PORT }}"' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Environment="REDIS_ENDPOINT=${{ secrets.REDIS_ENDPOINT }}"' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Environment="AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}"' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Environment="AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}"' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'Environment="FITROOM_API_KEY=${{ secrets.FITROOM_API_KEY }}"' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo '' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo '[Install]' | sudo tee -a /etc/systemd/system/thefirsttake.service
#             echo 'WantedBy=multi-user.target' | sudo tee -a /etc/systemd/system/thefirsttake.service

#             # systemd ë°ëª¬ì„ ë¦¬ë¡œë“œí•˜ì—¬ ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ íŒŒì¼ì„ ì¸ì‹í•˜ê²Œ í•©ë‹ˆë‹¤.
#             sudo systemctl daemon-reload
            
#             # ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•˜ê³  ì‹œì‘í•©ë‹ˆë‹¤.
#             # 'enable'ì€ ì‹œìŠ¤í…œ ë¶€íŒ… ì‹œ ì„œë¹„ìŠ¤ê°€ ìë™ìœ¼ë¡œ ì‹œì‘ë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
#             # 'start'ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì¦‰ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.
#             sudo systemctl enable thefirsttake.service
            
#             # ì„œë¹„ìŠ¤ ì‹œì‘ ì „ì— ìƒì„±ëœ ì„œë¹„ìŠ¤ íŒŒì¼ ë‚´ìš©ì„ í™•ì¸í•©ë‹ˆë‹¤.
#             echo "=== Generated Service File Content ==="
#             sudo cat /etc/systemd/system/thefirsttake.service
            
#             sudo systemctl start thefirsttake.service
            
#             # ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•˜ì—¬ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
#             # --no-pager ì˜µì…˜ì€ ì¶œë ¥ì´ í˜ì´ì§€ë„¤ì´ì…˜ë˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
#             # ì´ ëª…ë ¹ì€ ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
#             sudo systemctl status thefirsttake.service --no-pager
            
#             # ì„œë¹„ìŠ¤ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ì˜¤ë¥˜ ì›ì¸ì„ íŒŒì•…í•©ë‹ˆë‹¤.
#             echo "=== Service Logs ==="
#             sudo journalctl -u thefirsttake.service --no-pager -n 50
            
#             # ì„œë¹„ìŠ¤ê°€ ì‹¤íŒ¨í•œ ê²½ìš° ìƒì„¸ ë¡œê·¸ í™•ì¸
#             if ! sudo systemctl is-active --quiet thefirsttake.service; then
#                 echo "=== Service Failed - Checking Detailed Logs ==="
#                 sudo journalctl -u thefirsttake.service --no-pager -n 100
#                 echo "=== Generated Service File ==="
#                 sudo cat /etc/systemd/system/thefirsttake.service
#                 exit 1
#             fi

name: Deploy to ECS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x ./thefirsttake/gradlew

    - name: Build Spring Boot Application
      run: |
        cd thefirsttake
        ./gradlew clean build -x test

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: spring-boot-jar
        path: thefirsttake/build/libs/*.jar

  deploy-backend:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifact
      uses: actions/download-artifact@v4
      with:
        name: spring-boot-jar
        path: thefirsttake/build/libs/

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push Backend image
      id: build-backend
      env:
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_BACKEND }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸ”¨ Building Docker image..."
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./thefirsttake
        
        echo "ğŸ“¤ Pushing image to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        
        echo "âœ… Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Download current task definition
      run: |
        echo "ğŸ“‹ Downloading current task definition..."
        aws ecs describe-task-definition \
          --task-definition thefirsttake-backend \
          --query 'taskDefinition' > task-definition.json

    - name: Update task definition with new image and environment variables
      id: task-def
      run: |
        echo "ğŸ”„ Updating task definition..."
        
        # ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¡œ ì—…ë°ì´íŠ¸í•˜ê³  í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        jq --arg IMAGE "${{ steps.build-backend.outputs.image }}" \
           --arg POSTGRES_USER "${{ secrets.POSTGRES_USER }}" \
           --arg POSTGRES_PASSWORD "${{ secrets.POSTGRES_PASSWORD }}" \
           --arg POSTGRES_ENDPOINT "${{ secrets.POSTGRES_ENDPOINT }}" \
           --arg LLM_SERVER_HOST "${{ secrets.LLM_SERVER_HOST }}" \
           --arg LLM_SERVER_PORT "${{ secrets.LLM_SERVER_PORT }}" \
           --arg AI_SERVER_HOST "${{ secrets.AI_SERVER_HOST }}" \
           --arg AI_SERVER_PORT "${{ secrets.AI_SERVER_PORT }}" \
           --arg REDIS_ENDPOINT "${{ secrets.REDIS_ENDPOINT }}" \
           --arg AWS_ACCESS_KEY "${{ secrets.AWS_ACCESS_KEY }}" \
           --arg AWS_SECRET_KEY "${{ secrets.AWS_SECRET_KEY }}" \
           --arg FITROOM_API_KEY "${{ secrets.FITROOM_API_KEY }}" \
           '
           .containerDefinitions[0].image = $IMAGE |
           .containerDefinitions[0].environment = [
             {"name": "SPRING_DATASOURCE_URL", "value": ("jdbc:postgresql://" + $POSTGRES_ENDPOINT + ":5432/postgres?sslmode=require")},
             {"name": "SPRING_DATASOURCE_USERNAME", "value": $POSTGRES_USER},
             {"name": "SPRING_DATASOURCE_PASSWORD", "value": $POSTGRES_PASSWORD},
             {"name": "SPRING_DATASOURCE_DRIVER_CLASS_NAME", "value": "org.postgresql.Driver"},
             {"name": "LLM_SERVER_HOST", "value": $LLM_SERVER_HOST},
             {"name": "LLM_SERVER_PORT", "value": $LLM_SERVER_PORT},
             {"name": "AI_SERVER_HOST", "value": $AI_SERVER_HOST},
             {"name": "AI_SERVER_PORT", "value": $AI_SERVER_PORT},
             {"name": "REDIS_ENDPOINT", "value": $REDIS_ENDPOINT},
             {"name": "AWS_ACCESS_KEY", "value": $AWS_ACCESS_KEY},
             {"name": "AWS_SECRET_KEY", "value": $AWS_SECRET_KEY},
             {"name": "FITROOM_API_KEY", "value": $FITROOM_API_KEY}
           ] |
           del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .placementConstraints, .compatibilities, .registeredAt, .registeredBy)
           ' task-definition.json > new-task-definition.json

    - name: Register new task definition
      id: register-task-def
      run: |
        echo "ğŸ“ Registering new task definition..."
        NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
          --cli-input-json file://new-task-definition.json \
          --query 'taskDefinition.taskDefinitionArn' \
          --output text)
        
        echo "âœ… New task definition: $NEW_TASK_DEF_ARN"
        echo "task-def-arn=$NEW_TASK_DEF_ARN" >> $GITHUB_OUTPUT

    - name: Update ECS Backend Service
      run: |
        echo "ğŸš€ Updating ECS service..."
        aws ecs update-service \
          --cluster ${{ env.ECS_CLUSTER }} \
          --service ${{ secrets.ECS_SERVICE_BACKEND }} \
          --task-definition ${{ steps.register-task-def.outputs.task-def-arn }} \
          --force-new-deployment

    - name: Wait for service stability
      run: |
        echo "â³ Waiting for service to stabilize..."
        aws ecs wait services-stable \
          --cluster ${{ env.ECS_CLUSTER }} \
          --services ${{ secrets.ECS_SERVICE_BACKEND }}
        
        echo "âœ… Service deployment completed!"

  health-check:
    needs: deploy-backend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Health Check
      run: |
        echo "ğŸ” Performing health check..."
        
        for i in {1..30}; do
          if curl -f -s https://the-second-take.com/actuator/health; then
            echo "âœ… Health check passed!"
            exit 0
          fi
          echo "Waiting for service to be healthy... ($i/30)"
          sleep 10
        done
        
        echo "âŒ Health check failed after 5 minutes!"
        exit 1

    - name: Deployment Success Notification
      if: success()
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸŒ Service URL: https://the-second-take.com"
        echo "ğŸ¥ Health Check: https://the-second-take.com/actuator/health"