<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>멀티 전문가 SSE 스트림 테스트</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#f6f7f9; margin:0; padding:24px; }
        .container { max-width: 1100px; margin: 0 auto; background:#fff; border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); padding:24px; }
        h1 { margin: 0 0 8px; }
        .desc { color:#666; margin-bottom: 16px; }
        .grid { display:grid; grid-template-columns: 1fr 2fr; gap:16px; }
        .panel { background:#fafbfc; border:1px solid #e7e9ee; border-radius:10px; padding:16px; }
        .panel h3 { margin-top:0; }
        .form-row { display:flex; gap:10px; margin-bottom:10px; align-items:center; }
        .form-row label { min-width:120px; color:#333; }
        .form-row input[type="text"], .form-row input[type="number"] { flex:1; padding:10px; border:1px solid #d9dde7; border-radius:8px; font-size:14px; }
        .chips { display:flex; gap:8px; flex-wrap:wrap; }
        .chip { display:inline-flex; align-items:center; gap:6px; padding:8px 10px; background:#eef2ff; border:1px solid #c7d2fe; color:#1d4ed8; border-radius:999px; font-size:12px; }
        .chip input { margin:0; }
        .actions { display:flex; gap:10px; margin-top:8px; }
        button { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
        .primary { background:#2563eb; color:#fff; }
        .secondary { background:#e5e7eb; }
        .status { margin-top:12px; font-size:13px; color:#555; }
        .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
        .dot.connecting { background:#f59e0b; }
        .dot.connected { background:#10b981; }
        .dot.disconnected { background:#ef4444; }
        .chat { display:flex; flex-direction:column; gap:14px; max-height:600px; overflow:auto; }
        .agent { border:1px solid #e5e7eb; background:#fff; border-radius:12px; padding:14px; }
        .agent-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
        .agent-title { font-weight:700; }
        .chunks { white-space:pre-wrap; line-height:1.6; }
        .products { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
        .product { width:120px; text-align:center; }
        .product img { width:120px; height:120px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb; }
        .event-log { margin-top:12px; max-height:200px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; background:#0b1020; color:#bfe1ff; padding:10px; border-radius:8px; }
        .event-log .line { opacity:0.9; }
    </style>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
</head>
<body>
    <div class="container">
        <h1>멀티 전문가 스트리밍 테스트</h1>
        <div class="desc">한 번의 SSE 연결로 여러 전문가의 스트리밍 응답을 말풍선으로 구분해 표시하고, 완료 시 상품 이미지를 함께 보여줍니다.</div>
        <div class="grid">
            <div class="panel">
                <h3>요청 설정</h3>
                <div class="form-row">
                    <label>채팅방 ID</label>
                    <input id="roomId" type="number" value="1">
                </div>
                <div class="form-row">
                    <label>사용자 입력</label>
                    <input id="userInput" type="text" value="소개팅을 가야 하는데 입을 옷을 추천해줘">
                </div>
                
                
                <div class="actions">
                    <button class="primary" id="startBtn">SSE 시작</button>
                    <button class="secondary" id="stopBtn" disabled>SSE 중지</button>
                </div>
                <div class="status"><span class="dot disconnected" id="statusDot"></span><span id="statusText">연결 대기</span></div>
            </div>
            <div class="panel">
                <h3>응답</h3>
                <div id="chat" class="chat"></div>
            </div>
        </div>
        <div class="panel" style="margin-top:16px;">
            <h3>이벤트 로그</h3>
            <div class="event-log" id="log"></div>
        </div>
    </div>

    <script>
        let es = null;
        const chatEl = document.getElementById('chat');
        const logEl = document.getElementById('log');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        let expectedExperts = 0;
        let completeCount = 0;

        function log(line) {
            const div = document.createElement('div');
            div.className = 'line';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${line}`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function setStatus(s) {
            statusDot.className = 'dot ' + s;
            if (s === 'connected') statusText.textContent = 'SSE 연결됨';
            else if (s === 'connecting') statusText.textContent = 'SSE 연결 중...';
            else statusText.textContent = 'SSE 연결 해제';
        }

        function upsertAgentCard(agentId) {
            let el = chatEl.querySelector(`[data-agent="${agentId}"]`);
            if (!el) {
                el = document.createElement('div');
                el.className = 'agent';
                el.dataset.agent = agentId;
                const header = document.createElement('div');
                header.className = 'agent-header';
                const title = document.createElement('div');
                title.className = 'agent-title';
                title.textContent = agentLabel(agentId);
                const status = document.createElement('div');
                status.className = 'agent-status';
                status.textContent = '스트리밍 중...';
                header.appendChild(title);
                header.appendChild(status);
                const chunks = document.createElement('div');
                chunks.className = 'chunks';
                const products = document.createElement('div');
                products.className = 'products';
                el.appendChild(header);
                el.appendChild(chunks);
                el.appendChild(products);
                chatEl.appendChild(el);
            }
            return el;
        }

        function agentLabel(id) {
            switch(id) {
                case 'style_analyst': return '스타일 분석가';
                case 'trend_expert': return '트렌드 전문가';
                case 'color_expert': return '컬러 전문가';
                case 'fitting_coordinator': return '피팅 코디네이터';
                default: return id || '알 수 없음';
            }
        }

        function start() {
            if (es) { log('이미 연결되어 있습니다.'); return; }
            const roomId = document.getElementById('roomId').value.trim();
            const userInput = document.getElementById('userInput').value;
            const params = new URLSearchParams({ user_input: userInput });
            expectedExperts = 3; // 기본 3명 (전문가 선택 UI 제거됨)
            completeCount = 0;

            let url;
            if (roomId) {
                url = `/api/chat/rooms/${encodeURIComponent(roomId)}/messages/stream?` + params.toString();
            } else {
                // room_id 없이 시작 → 서버가 방 생성, 첫 room 이벤트로 내려줌
                url = `/api/chat/rooms/messages/stream?` + params.toString();
            }
            log(`연결 요청 → ${url}`);
            es = new EventSource(url);
            setStatus('connecting');
            startBtn.disabled = true; stopBtn.disabled = false;

            es.onopen = () => { setStatus('connected'); log('SSE opened'); };
            es.addEventListener('room', (e) => {
                try {
                    const msg = JSON.parse(e.data);
                    const roomIdFromServer = (msg && msg.data && msg.data.room_id) ? msg.data.room_id : null;
                    if (roomIdFromServer) {
                        log(`room 이벤트 수신: room_id=${roomIdFromServer}`);
                        // UI에 반영
                        const roomInput = document.getElementById('roomId');
                        if (!roomInput.value) roomInput.value = roomIdFromServer;
                    }
                } catch (err) { log('room parse error: ' + err.message); }
            });

            es.addEventListener('content', (e) => {
                try {
                    const msg = JSON.parse(e.data);
                    
                    // CommonResponse 형식 처리
                    let agentId = 'unknown';
                    let contentData = '';
                    let agentName = '알 수 없음';
                    
                    if (msg.status === 'success' && msg.data) {
                        // 새로운 형식: SSE 이벤트 자체가 CommonResponse
                        agentId = msg.data.agent_id || 'unknown';
                        agentName = msg.data.agent_name || agentLabel(agentId);
                        contentData = msg.data.message || '';
                    } else {
                        // 기존 형식: {data: "...", agent_id: "..."}
                        agentId = msg.agent_id || 'unknown';
                        agentName = agentLabel(agentId);
                        contentData = msg.data || '';
                    }
                    
                    const card = upsertAgentCard(agentId);
                    const chunks = card.querySelector('.chunks');
                    chunks.textContent += contentData;
                    chatEl.scrollTop = chatEl.scrollHeight;
                } catch (err) { log('content parse error: ' + err.message); }
            });
            es.addEventListener('complete', (e) => {
                try {
                    const msg = JSON.parse(e.data);
                    
                    // CommonResponse 형식 처리
                    let agentId = 'unknown';
                    let data = {};
                    
                    if (msg.status === 'success' && msg.data) {
                        // 새로운 형식: SSE 이벤트 자체가 CommonResponse
                        agentId = msg.data.agent_id || 'unknown';
                        data = msg.data;
                    } else {
                        // 기존 형식: {data: {...}, agent_id: "..."}
                        agentId = msg.agent_id || 'unknown';
                        data = msg.data || {};
                    }
                    
                    const card = upsertAgentCard(agentId);
                    const header = card.querySelector('.agent-status');
                    header.textContent = '완료';
                    const products = card.querySelector('.products');
                    
                    const items = (data.products || []).slice(0, 6);
                    log(`상품 정보: ${JSON.stringify(items)}`);
                    products.innerHTML = '';
                    for (const it of items) {
                        const p = document.createElement('div');
                        p.className = 'product';
                        const img = document.createElement('img');
                        img.src = it.product_url || it.productUrl || '';
                        img.alt = it.product_id || it.productId || '';
                        img.onerror = function() {
                            this.style.display = 'none';
                        };
                        p.appendChild(img); 
                        products.appendChild(p);
                    }
                    completeCount += 1;
                    log(`complete 수신 (${completeCount}/${expectedExperts}) from ${agentId} - SSE CommonResponse 형식: ${msg.status || 'legacy'}`);
                    if (completeCount >= expectedExperts) {
                        log('모든 전문가 완료. SSE 종료.');
                        stop();
                    }
                } catch (err) { log('complete parse error: ' + err.message); }
            });
            es.addEventListener('error', (e) => {
                log('SSE error');
                // 연결이 살아있어도 error 이벤트는 발생할 수 있음
            });
        }

        function stop() {
            if (es) { es.close(); es = null; }
            setStatus('disconnected');
            startBtn.disabled = false; stopBtn.disabled = true;
            log('SSE closed');
        }

        document.getElementById('startBtn').addEventListener('click', start);
        document.getElementById('stopBtn').addEventListener('click', stop);
    </script>
</body>
</html>


